{% extends "base.html" %}

{% block title %}Quiz Results - {{ topic_name }}{% endblock %}

{% block content %}
<h1>Quiz Results for {{ topic_name }}</h1>
<h2>Your Score: {{ "%.2f"|format(score) }}%</h2>

<div class="feedback-summary">
    {% for result in feedback_results %}
    <div class="feedback-item {% if result.is_correct %}correct{% else %}incorrect{% endif %}">
        <h3>{{ result.question }}</h3>
        <p>Your answer: {{ result.user_answer }}</p>
        <p>Correct answer: {{ result.correct_answer }}</p>
        <p>Feedback: {{ result.feedback }}</p>
    </div>
    {% endfor %}
</div>

<div class="actions" style="margin-top: 20px; display: flex; gap: 10px;">
    <a href="{{ url_for('main.index') }}" class="button">Back to Home</a>
    <a href="{{ url_for('quiz.export_quiz_pdf', topic_name=topic_name) }}" class="button secondary"
        id="export-pdf-btn">Save as PDF</a>
</div>

<script>
    document.getElementById('export-pdf-btn').addEventListener('click', async function (e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const text = await response.text();
                alert(text);
            } else {
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = "quiz_results_{{ topic_name }}.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
        } catch (err) {
            alert("An unknown error occurred while trying to export.");
        }
    });
</script>
{% endblock %}
