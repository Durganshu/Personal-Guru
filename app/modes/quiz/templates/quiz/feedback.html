{% extends "base.html" %}

{% block title %}Quiz Results - {{ topic_name }}{% endblock %}

{% block content %}
<h1>Quiz Results for {{ topic_name }}</h1>
<h2>Your Score: {{ "%.2f"|format(score) }}%</h2>

<div class="feedback-summary">
    {% for result in feedback_results %}
    <div class="feedback-card {{ 'is-correct' if result.is_correct else 'is-incorrect' }}">
        <div class="feedback-header">
            <div class="feedback-status-icon">
                {% if result.is_correct %}
                <svg viewBox="0 0 24 24" class="icon-svg">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
                {% else %}
                <svg viewBox="0 0 24 24" class="icon-svg">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
                {% endif %}
            </div>
            <h3 class="feedback-question">{{ result.question }}</h3>
        </div>

        <div class="feedback-details">
            <div class="feedback-row user-answer">
                <span class="label">Your Answer:</span>
                <span class="value">{{ result.user_answer }}</span>
            </div>

            {% if not result.is_correct %}
            <div class="feedback-row correct-answer">
                <span class="label">Correct Answer:</span>
                <span class="value">{{ result.correct_answer }}</span>
            </div>
            {% endif %}

            <div class="feedback-row explanation">
                <span class="label">Analysis:</span>
                <span class="value">{{ result.feedback }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{{ url_for('main.index') }}" class="button">Back to Home</a>
    <a href="{{ url_for('quiz.export_quiz_pdf', topic_name=topic_name) }}" class="button secondary"
        id="export-pdf-btn">Save as PDF</a>

    <form action="{{ url_for('quiz.reset_quiz', topic_name=topic_name) }}" method="post" style="margin: 0;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="jwe_token" value="{{ jwe_token if jwe_token else '' }}">
        <button type="submit" class="button secondary">Retake / New Quiz</button>
    </form>
</div>

<script>
    document.getElementById('export-pdf-btn').addEventListener('click', async function (e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const text = await response.text();
                alert(text);
            } else {
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = "quiz_results_{{ topic_name }}.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
        } catch (err) {
            alert("An unknown error occurred while trying to export.");
        }
    });
</script>
{% endblock %}
