{% if progress_data %}
<!-- Book is actively generating -->
<div class="book-card generating" id="book-card-{{ book.id }}">
    <span class="generation-badge">
        <i class="fas fa-spinner fa-spin"></i> Publishing
    </span>
    <div class="generating-scroll-body">
        {% include 'library/_book_generation_progress.html' %}
    </div>
</div>
{% elif needs_generation %}
<!-- Book needs generation -->
<div class="book-card" id="book-card-{{ book.id }}" style="border: 2px dashed var(--primary-color, #cba6f7);">
    <div class="mini-placeholder" style="cursor: default; opacity: 0.5;">
        <i class="fas fa-book-medical"></i>
        <span>Ready for content</span>
    </div>
    <div class="book-card-body">
        <h3 style="margin: 0 0 0.5rem;">{{ book.title }}</h3>
        <p style="color: #a6adc8; font-size: 0.85rem; line-height: 1.4;">{{ book.description | truncate(100) }}</p>
        <div class="alert alert-warning mb-2" style="padding: 0.4rem 0.6rem; font-size: 0.8rem; background: rgba(250, 179, 135, 0.1); border-color: rgba(250, 179, 135, 0.2); color: #fab387;">
            <i class="fas fa-exclamation-triangle"></i> Incomplete content
        </div>
        <button class="btn btn-primary w-100" onclick="startBookGeneration({{ book.id }}, event)">
            <i class="fas fa-play"></i> Generate Content
        </button>
    </div>
    <div class="flat-actions">
        <a href="{{ url_for('library.edit_book', book_id=book.id) }}" class="btn btn-sm btn-warning" onclick="event.stopPropagation()"><i class="fas fa-edit"></i> Edit</a>
        <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }}, event)"><i class="fas fa-trash"></i> Delete</button>
    </div>
</div>

{% elif book.cover_path %}
<!-- === FLIP CARD: has cover === -->
<div class="flip-card" id="book-card-{{ book.id }}">
    <div class="flip-card-inner">
        <!-- FRONT: Cover + Title -->
        <div class="flip-card-front" onclick="flipCard(this.closest('.flip-card'), event)">
            <span class="flip-hint"><i class="fas fa-sync-alt"></i> Tap to flip</span>
            <!-- Adding timestamp as cache buster for newly generated covers -->
            <img src="{{ url_for('library.serve_cover', book_id=book.id) }}?t={{ book.modified_at.timestamp() | int }}" alt="{{ book.title }}" class="cover-img">
            <div class="cover-title">{{ book.title }}</div>
        </div>
        <!-- BACK: Details + Actions -->
        <div class="flip-card-back" onclick="flipCard(this.closest('.flip-card'), event)">
            <h3>{{ book.title }}</h3>
            <div class="book-desc">{{ book.description | truncate(200) }}</div>
            <div class="card-actions">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small style="font-size: 0.75rem; color: #a6adc8;">{{ book.book_topics | length }} Topics</small>
                    <span class="badge {{ 'bg-success' if book.is_shared else 'bg-secondary' }}" style="font-size: 0.7rem; opacity: 0.8;">
                        {{ 'Shared' if book.is_shared else 'Private' }}
                    </span>
                </div>
                <button class="btn btn-primary" onclick="event.stopPropagation(); openBookWithLoader({{ book.id }}, this.closest('.flip-card'))">
                    <i class="fas fa-book-open"></i> Read Book
                </button>
                <div class="card-actions-row">
                    <a href="{{ url_for('library.edit_book', book_id=book.id) }}" class="btn btn-sm btn-warning" onclick="event.stopPropagation()">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteBook({{ book.id }}, event)">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- === FLAT CARD: no cover === -->
<div class="book-card" id="book-card-{{ book.id }}">
    <div class="mini-placeholder" onclick="retryBookCover({{ book.id }}, event)" title="Click to generate cover">
        <i class="fas fa-image"></i>
        <span>Generate cover</span>
    </div>
    <div class="book-card-body">
        <h3 style="margin: 0 0 0.5rem;">{{ book.title }}</h3>
        <p style="color: #a6adc8; font-size: 0.85rem; margin-bottom: 0.5rem; line-height: 1.4;">{{ book.description | truncate(140) }}</p>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <small style="font-size: 0.75rem;">{{ book.book_topics | length }} Topics</small>
            <span class="badge {{ 'bg-success' if book.is_shared else 'bg-secondary' }}" style="font-size: 0.7rem;">
                {{ 'Shared' if book.is_shared else 'Private' }}
            </span>
        </div>
    </div>
    <div class="flat-actions">
        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openBookWithLoader({{ book.id }}, this.closest('.book-card'))"><i class="fas fa-book-open"></i> Read</button>
        <a href="{{ url_for('library.edit_book', book_id=book.id) }}" class="btn btn-sm btn-warning" onclick="event.stopPropagation()"><i class="fas fa-edit"></i> Edit</a>
        <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }}, event)"><i class="fas fa-trash"></i> Delete</button>
    </div>
</div>
{% endif %}
