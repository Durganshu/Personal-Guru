{% extends "base.html" %}

{% block title %}Library - Personal Guru{% endblock %}
{% block head %}
{{ super() }}
<style>
    .library-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    .library-tabs {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    .book-card {
        background: var(--surface-color, #1e1e2e);
        border: 1px solid var(--border-color, #313244);
        border-radius: 12px;
        padding: 1.5rem;
        transition: transform 0.2s;
        cursor: pointer;
        position: relative;
    }
    .book-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color, #cba6f7);
    }
    .book-card.generating {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
    .generation-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        animation: pulse-badge 2s infinite;
    }
    @keyframes pulse-badge {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    .search-bar {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 2rem;
        display: flex;
        gap: 0.5rem;
    }
    .generate-panel {
        background: rgba(203, 166, 247, 0.1);
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        margin-top: 2rem;
    }
    .active-tab {
        background: var(--primary-color, #cba6f7);
        color: #11111b;
    }
</style>
<script>
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
        document.getElementById('btn-' + tabId).classList.add('active-tab');
    }

    function filterBooks(inputId, gridId) {
        const query = document.getElementById(inputId).value.toLowerCase();
        const grid = document.getElementById(gridId);
        if (!grid) return;
        const cards = grid.getElementsByClassName('book-card');
        for (let i = 0; i < cards.length; i++) {
            const textContent = cards[i].innerText || cards[i].textContent;
            if (textContent.toLowerCase().includes(query)) {
                cards[i].style.display = "";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    async function searchLibrary(e) {
        e.preventDefault();
        const query = document.getElementById('searchInput').value;
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = "Searching and curating...";

        try {
            const res = await fetch(`/library/search?q=${encodeURIComponent(query)}`);
            if (!res.ok) {
                if (res.status === 404) {
                    resultsDiv.innerHTML = "No existing content found. Try Generating a new book!";
                    return;
                }
                throw new Error("Search failed");
            }
            const data = await res.json();

            const cardHtml = `
                <div class="book-card" id="suggested-book-card">
                    <h3>Curated: ${data.title}</h3>
                    <p>${data.description}</p>
                    <small>Topics: ${data.topic_ids.join(', ')}</small>
                    <button class="btn btn-sm" style="width:100%; margin-top:1rem;">Save this Book</button>
                </div>
            `;
            resultsDiv.innerHTML = cardHtml;

            // Avoid inline onclick to prevent quote escaping issues
            document.getElementById('suggested-book-card').addEventListener('click', () => {
                createFromSuggestion(data.title, data.description, data.topic_ids);
            });
        } catch (err) {
            resultsDiv.innerHTML = "Error during search: " + err.message;
        }
    }

    async function createFromSuggestion(title, description, topic_ids) {
        try {
            const res = await fetch('/library/create-from-suggestion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'X-JWE-Token': document.querySelector('meta[name="jwe-token"]').getAttribute('content')
                },
                body: JSON.stringify({title, description, topic_ids})
            });
            const data = await res.json();
            if (data.success) {
                window.location.href = `/library/${data.book_id}/page/1`;
            }
        } catch (err) {
            alert("Error saving book.");
        }
    }

    async function generateBook(e) {
        e.preventDefault();
        const query = document.getElementById('genInput').value;
        const btn = document.getElementById('genBtn');
        btn.disabled = true;
        btn.innerText = "Structuring Book Plan...";

        // Ensure progress container exists for inline loading
        let progressContainer = document.getElementById('generate-progress-container');
        if (!progressContainer) {
            progressContainer = document.createElement('div');
            progressContainer.id = 'generate-progress-container';
            progressContainer.className = 'mt-4 text-center p-3 border rounded bg-light';
            btn.parentElement.parentElement.appendChild(progressContainer);
        }
        progressContainer.style.display = 'block';
        progressContainer.innerHTML = '<strong>Step 1/2:</strong> Structuring topics (takes ~10 seconds)...';

        try {
            const res = await fetch('/library/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'X-JWE-Token': document.querySelector('meta[name="jwe-token"]').getAttribute('content')
                },
                body: JSON.stringify({query: query})
            });
            const data = await res.json();
            if (data.success && data.book && data.book.id) {
                progressContainer.innerHTML = '<strong>Step 2/2:</strong> Book structured! Generating chapters...';
                // Trigger the background content generation using the same logic as the dashboard cards
                await openBookWithLoader(data.book.id, progressContainer);
            } else if (data.success && data.redirect) {
                 // Fallback if no book ID but success
                 window.location.href = data.redirect;
            } else {
                progressContainer.innerHTML = `<span class="text-danger">Failed to generate book: ${data.error || "Unknown Error"}</span>`;
                btn.disabled = false;
                btn.innerText = "Generate Book Plan";
            }
        } catch(err) {
            progressContainer.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
            btn.disabled = false;
            btn.innerText = "Generate Book Plan";
        }
    }

    async function openBookWithLoader(bookId, element) {
        // Prevent multiple clicks
        if (element.classList.contains('generating')) return;
        element.classList.add('generating');
        element.style.opacity = '0.7';
        element.style.pointerEvents = 'none'; // Disable clicking again

        let progressDiv = element.querySelector('.generation-progress');
        if (!progressDiv) {
            progressDiv = document.createElement('div');
            progressDiv.className = 'generation-progress mt-2 fw-bold text-primary';
            progressDiv.style.fontSize = '0.85em';
            element.appendChild(progressDiv);
        }
        progressDiv.style.display = 'block';
        progressDiv.innerText = "Initializing Book...";

        try {
            const res = await fetch(`/library/${bookId}/init`);
            const data = await res.json();

            if (data.status === 'ready') {
                window.location.href = data.redirect || `/library/${bookId}/page/1`;
            } else if (data.status === 'generating' || data.status === 'pending') {
                progressDiv.innerText = data.message || "Generating Content...";

                // Polling progress every 3 seconds
                const pollInterval = setInterval(async () => {
                    try {
                        const pollRes = await fetch(`/library/${bookId}/progress`);
                        const pollData = await pollRes.json();

                        if (pollData.status === 'ready') {
                            clearInterval(pollInterval);
                            progressDiv.innerText = "Complete! Opening book...";
                            window.location.href = `/library/${bookId}/page/1`;
                        } else if (pollData.status === 'error') {
                            clearInterval(pollInterval);
                            alert("Generation Error: " + pollData.message);
                            progressDiv.innerText = "Error generating book.";
                            progressDiv.className = 'generation-progress mt-2 fw-bold text-danger';
                            element.classList.remove('generating');
                            element.style.opacity = '1';
                            element.style.pointerEvents = 'auto';
                        } else if (pollData.status === 'generating' || pollData.status === 'pending') {
                            progressDiv.innerText = pollData.message || "Generating Content...";
                        }
                    } catch (e) {
                        console.error("Polling error:", e);
                    }
                }, 3000);
            } else {
                alert("Error initializing book.");
                progressDiv.innerText = "Error initializing book.";
                element.classList.remove('generating');
                element.style.opacity = '1';
                element.style.pointerEvents = 'auto';
            }
        } catch (e) {
            alert("Error: " + e.message);
            progressDiv.innerText = "Error connecting to server.";
            element.classList.remove('generating');
            element.style.opacity = '1';
            element.style.pointerEvents = 'auto';
        }
    }

    async function deleteBook(bookId, event) {
        event.stopPropagation(); // Prevent card click

        if (!confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
            return;
        }

        try {
            const res = await fetch(`/library/${bookId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'X-JWE-Token': document.querySelector('meta[name="jwe-token"]').getAttribute('content')
                }
            });

            const data = await res.json();
            if (data.success) {
                // Remove the card from the UI
                event.target.closest('.book-card').remove();
            } else {
                alert('Failed to delete book: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Error deleting book: ' + e.message);
        }
    }

    async function startBookGeneration(bookId, event) {
        event.stopPropagation(); // Prevent card click

        const button = event.target.closest('button');
        const card = document.getElementById('book-card-' + bookId);

        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

        try {
            // Call the init endpoint to start generation
            const res = await fetch(`/library/${bookId}/init`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'X-JWE-Token': document.querySelector('meta[name="jwe-token"]').getAttribute('content')
                }
            });

            const data = await res.json();

            if (data.status === 'generating' || data.status === 'pending') {
                // Reload the page to show the progress component
                window.location.reload();
            } else if (data.status === 'ready') {
                // Book is already complete, open it
                window.location.href = data.redirect || `/library/${bookId}/page/1`;
            } else {
                alert('Error starting generation: ' + (data.message || 'Unknown error'));
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play"></i> Generate Content';
            }
        } catch (e) {
            alert('Error: ' + e.message);
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> Generate Content';
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="library-header">
        <h1>Library</h1>
        <p>Curate, Discover, and Generate Knowledge Books</p>
    </div>

    <div class="library-tabs">
        <button id="btn-my-books" class="btn tab-btn active-tab" onclick="switchTab('my-books')">My Books</button>
        <button id="btn-search-topics" class="btn tab-btn" onclick="switchTab('search-topics')">Curate from Topics</button>
        <button id="btn-generate-book" class="btn tab-btn" onclick="switchTab('generate-book')">AI Book Generation</button>
        <button id="btn-shared-books" class="btn tab-btn" onclick="switchTab('shared-books')">Community Books</button>
    </div>

    <div id="my-books" class="tab-content">
        <div class="search-bar mb-4">
            <input type="text" id="myBooksSearch" class="form-control" placeholder="Search my books..." onkeyup="filterBooks('myBooksSearch', 'my-books-grid')">
        </div>
        <!-- Debug info -->
        <div style="display:none;">
            book_progress: {{ book_progress }}
            book_needs_generation: {{ book_needs_generation }}
        </div>
        <div class="grid-container" id="my-books-grid">
            {% for book in my_books %}
            <!-- Debug: book.id={{ book.id }}, in_progress={{ book.id in book_progress }}, needs_gen={{ book.id in book_needs_generation }}, value={{ book_needs_generation.get(book.id, 'N/A') }} -->
            {% if book.id in book_progress %}
            <!-- Book is actively generating - show real progress -->
            <div class="book-card generating" id="book-card-{{ book.id }}">
                <span class="generation-badge">
                    <i class="fas fa-spinner fa-spin"></i> Publishing
                </span>
                {% include 'library/_book_generation_progress.html' %}
            </div>
            {% elif book.id in book_needs_generation and book_needs_generation[book.id] %}
            <!-- Book needs generation - show generate button -->
            <div class="book-card" id="book-card-{{ book.id }}" style="border: 2px dashed #667eea;">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h3 style="flex: 1; margin: 0;">{{ book.title }}</h3>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('library.edit_book', book_id=book.id) }}" class="btn btn-sm btn-warning" onclick="event.stopPropagation()" title="Edit book" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }}, event)" title="Delete book" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p>{{ book.description | truncate(100) }}</p>
                <div class="mt-3">
                    <div class="alert alert-warning mb-2" style="padding: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> This book has incomplete content
                    </div>
                    <button class="btn btn-primary w-100" onclick="startBookGeneration({{ book.id }}, event)">
                        <i class="fas fa-play"></i> Generate Content
                    </button>
                </div>
            </div>
            {% else %}
            <!-- Normal complete book card -->
            <div class="book-card" onclick="openBookWithLoader({{ book.id }}, this)">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h3 style="flex: 1; margin: 0;">{{ book.title }}</h3>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('library.edit_book', book_id=book.id) }}" class="btn btn-sm btn-warning" onclick="event.stopPropagation()" title="Edit book" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }}, event)" title="Delete book" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p>{{ book.description | truncate(100) }}</p>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small>{{ book.book_topics | length }} Topics</small>
                    <span class="badge {{ 'bg-success' if book.is_shared else 'bg-secondary' }}">
                        {{ 'Shared' if book.is_shared else 'Private' }}
                    </span>
                </div>
            </div>
            {% endif %}
            {% else %}
            <p class="text-center w-100">You don't have any books yet. Try curating or generating one!</p>
            {% endfor %}
        </div>
    </div>

    <div id="search-topics" class="tab-content" style="display:none;">
        <form class="search-bar" onsubmit="searchLibrary(event)">
            <input type="text" id="searchInput" class="form-control" placeholder="Search your knowledge base (e.g. 'Advanced Python')">
            <button class="btn btn-primary" type="submit">Curate</button>
        </form>
        <div id="searchResults" class="grid-container">
            <!-- Results populate here -->
        </div>
    </div>

    <div id="generate-book" class="tab-content" style="display:none;">
        <form class="generate-panel" onsubmit="generateBook(event)">
            <h3>Generate a New Book</h3>
            <p>Tell the AI Librarian what you want to learn, and it will structure a complete multi-topic book for you.</p>
            <div class="search-bar mt-4">
                <input type="text" id="genInput" class="form-control" placeholder="e.g. History of Rome or Quantum Computing">
                <button class="btn btn-primary" id="genBtn" type="submit">Generate Book Plan</button>
            </div>
        </form>
    </div>

    <div id="shared-books" class="tab-content" style="display:none;">
        <div class="search-bar mb-4">
            <input type="text" id="sharedBooksSearch" class="form-control" placeholder="Search community books..." onkeyup="filterBooks('sharedBooksSearch', 'shared-books-grid')">
        </div>
        <div class="grid-container" id="shared-books-grid">
            {% for book in shared_books %}
            <div class="book-card" onclick="openBookWithLoader({{ book.id }}, this)">
                <h3>{{ book.title }}</h3>
                <p>{{ book.description | truncate(100) }}</p>
                <div class="d-flex justify-content-between mt-3">
                    <small>By: {{ book.login.display_name }}</small>
                </div>
            </div>
            {% else %}
            <p class="text-center w-100">No community books available right now.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
